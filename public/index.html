<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Charged Up Properties - Admin</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #E10600;
      padding: 20px;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      color: #fff;
    }
    main {
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    form {
      background: #111;
      padding: 20px;
      margin-bottom: 40px;
      border-radius: 8px;
    }
    form input, form select, form textarea {
      display: block;
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #444;
      background: #222;
      color: #fff;
    }
    form button {
      background-color: #E10600;
      color: #fff;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 4px;
    }
    form button:hover {
      background-color: #b80000;
    }
    .property {
      background: #111;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .property h3 {
      margin-top: 0;
    }
    .property img {
      max-width: 150px;
      max-height: 100px;
      object-fit: cover;
      margin-right: 5px;
      cursor: pointer;
      border: 2px solid #444;
      border-radius: 4px;
    }
    .property .gallery img {
      max-width: 80px;
      max-height: 80px;
    }
    .property button {
      margin: 5px;
    }
    #imageModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
    }
    #imageModal img {
      max-width: 90%;
      max-height: 90%;
    }
    #imageModal span {
      position: absolute;
      top: 20px;
      right: 40px;
      font-size: 3rem;
      color: #fff;
      cursor: pointer;
    }
    .arrow {
      cursor: pointer;
      font-size: 2rem;
      color: #fff;
      margin: 0 10px;
      user-select: none;
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
    }
    .image-preview {
      position: relative;
      display: inline-block;
      margin-right: 5px;
    }
    .image-preview img {
      max-width: 100px;
      max-height: 100px;
      object-fit: cover;
      border: 2px solid #444;
      border-radius: 4px;
      cursor: pointer;
    }
    .image-preview button {
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      border: none;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>Charged Up Properties Admin</header>

<main>

  <form id="propertyForm">
    <input type="hidden" id="propertyId">

    <label>Name:</label>
    <input type="text" id="name" required>

    <label>Price:</label>
    <input type="number" id="price" required>

    <label>Status:</label>
    <select id="status" required>
      <option value="For Sale">For Sale</option>
      <option value="Pending">Pending</option>
      <option value="Sold">Sold</option>
    </select>

    <label>Address:</label>
    <input type="text" id="address">

    <label>Beds:</label>
    <input type="number" id="beds">

    <label>Baths (can use 1.5):</label>
    <input type="number" step="0.5" id="baths">

    <label>Square Footage:</label>
    <input type="number" id="sqft">

    <label>Type:</label>
    <input type="text" id="type">

    <label>Lot Size:</label>
    <input type="number" id="lot">

    <label>Basement:</label>
    <input type="text" id="basement">

    <label>Description:</label>
    <textarea id="description"></textarea>

    <label>Cover Image:</label>
    <input type="file" id="coverImage" accept="image/*">
    <div id="coverPreview"></div>

    <label>Gallery Images:</label>
    <input type="file" id="galleryImages" accept="image/*" multiple>
    <div id="galleryPreview" class="flex-row"></div>

    <button type="submit">Save Property</button>
  </form>

  <div id="propertyList"></div>

</main>

<div id="imageModal">
  <span id="closeModal">&times;</span>
  <span class="arrow" id="prev">&#10094;</span>
  <img id="modalImage">
  <span class="arrow" id="next">&#10095;</span>
</div>

<script>
const API_URL = "https://charged-up-properties-backend.onrender.com/api/properties";

let properties = [];
let currentZoomIndex = 0;
let currentGallery = [];
let editingProperty = null;

// Load properties from backend
async function loadProperties() {
  try {
    const res = await fetch(API_URL);
    properties = await res.json();
    renderProperties();
  } catch (err) {
    console.error("Failed to load properties:", err);
  }
}

// Render property list
function renderProperties() {
  const list = document.getElementById("propertyList");
  list.innerHTML = "";

  properties.forEach(prop => {
    const div = document.createElement("div");
    div.className = "property";

    div.innerHTML = `
      <h3>${prop.name} - $${prop.price}</h3>
      <p>Status: ${prop.status} | Beds: ${prop.beds} | Baths: ${prop.baths} | Sqft: ${prop.sqft}</p>
      <p>Address: ${prop.address}</p>
      <p>Type: ${prop.type} | Lot: ${prop.lot} | Basement: ${prop.basement}</p>
      <p>${prop.description || ""}</p>
      <div class="flex-row">
        ${prop.cover_image ? `<img src="${prop.cover_image}" data-id="${prop.id}" data-type="cover">` : ""}
        ${(prop.gallery_images || []).map(url => `<img src="${url}" data-id="${prop.id}" data-type="gallery">`).join("")}
      </div>
      <button onclick="editProperty(${prop.id})">Edit</button>
      <button onclick="deleteProperty(${prop.id})">Delete</button>
    `;
    list.appendChild(div);
  });

  document.querySelectorAll(".property img").forEach(img => {
    img.onclick = e => {
      const parentId = e.target.dataset.id;
      const type = e.target.dataset.type;
      const prop = properties.find(p => p.id == parentId);
      if (type === "cover") currentGallery = [prop.cover_image];
      else currentGallery = prop.gallery_images || [];
      currentZoomIndex = currentGallery.indexOf(e.target.src);
      showModal();
    };
  });
}

// Form submit
document.getElementById("propertyForm").addEventListener("submit", async e => {
  e.preventDefault();
  const id = document.getElementById("propertyId").value;
  const formData = new FormData();

  formData.append("name", document.getElementById("name").value);
  formData.append("price", document.getElementById("price").value);
  formData.append("status", document.getElementById("status").value);
  formData.append("address", document.getElementById("address").value);
  formData.append("beds", document.getElementById("beds").value);
  formData.append("baths", document.getElementById("baths").value);
  formData.append("sqft", document.getElementById("sqft").value);
  formData.append("type", document.getElementById("type").value);
  formData.append("lot", document.getElementById("lot").value);
  formData.append("basement", document.getElementById("basement").value);
  formData.append("description", document.getElementById("description").value);

  // Cover image
  const coverFile = document.getElementById("coverImage").files[0];
  if (coverFile) formData.append("coverImage", coverFile);

  // Gallery images
  const galleryFiles = document.getElementById("galleryImages").files;
  for (let f of galleryFiles) formData.append("galleryImages", f);

  if (id) {
    await fetch(`${API_URL}/${id}`, { method: "PUT", body: formData });
  } else {
    await fetch(API_URL, { method: "POST", body: formData });
  }

  document.getElementById("propertyForm").reset();
  document.getElementById("coverPreview").innerHTML = "";
  document.getElementById("galleryPreview").innerHTML = "";
  document.getElementById("propertyId").value = "";
  loadProperties();
});

// Edit property
function editProperty(id) {
  const prop = properties.find(p => p.id == id);
  document.getElementById("propertyId").value = id;
  document.getElementById("name").value = prop.name;
  document.getElementById("price").value = prop.price;
  document.getElementById("status").value = prop.status;
  document.getElementById("address").value = prop.address;
  document.getElementById("beds").value = prop.beds;
  document.getElementById("baths").value = prop.baths;
  document.getElementById("sqft").value = prop.sqft;
  document.getElementById("type").value = prop.type;
  document.getElementById("lot").value = prop.lot;
  document.getElementById("basement").value = prop.basement;
  document.getElementById("description").value = prop.description;

  // Cover preview
  const coverPreview = document.getElementById("coverPreview");
  coverPreview.innerHTML = "";
  if (prop.cover_image) {
    const div = document.createElement("div");
    div.className = "image-preview";
    div.innerHTML = `<img src="${prop.cover_image}"><button onclick="deleteCoverPreview(event)">x</button>`;
    coverPreview.appendChild(div);
  }

  // Gallery preview
  const galleryPreview = document.getElementById("galleryPreview");
  galleryPreview.innerHTML = "";
  (prop.gallery_images || []).forEach(url => {
    const div = document.createElement("div");
    div.className = "image-preview";
    div.innerHTML = `<img src="${url}"><button onclick="deleteGalleryPreview(event)">x</button>`;
    galleryPreview.appendChild(div);
  });
}

function deleteCoverPreview(e) {
  e.preventDefault();
  e.target.parentElement.remove();
}

function deleteGalleryPreview(e) {
  e.preventDefault();
  e.target.parentElement.remove();
}

// Delete property
async function deleteProperty(id) {
  if (!confirm("Delete this property?")) return;
  await fetch(`${API_URL}/${id}`, { method: "DELETE" });
  loadProperties();
}

// Modal zoom
const modal = document.getElementById("imageModal");
const modalImg = document.getElementById("modalImage");
const closeModalBtn = document.getElementById("closeModal");
const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");

function showModal() {
  if (currentGallery.length === 0) return;
  modal.style.display = "flex";
  modalImg.src = currentGallery[currentZoomIndex];
}

closeModalBtn.onclick = () => modal.style.display = "none";
prevBtn.onclick = () => {
  currentZoomIndex = (currentZoomIndex - 1 + currentGallery.length) % currentGallery.length;
  modalImg.src = currentGallery[currentZoomIndex];
};
nextBtn.onclick = () => {
  currentZoomIndex = (currentZoomIndex + 1) % currentGallery.length;
  modalImg.src = currentGallery[currentZoomIndex];
};

// Initial load
loadProperties();
</script>

</body>
</html>
