<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Charged Up Properties – Inventory</title>
<style>
:root{
  --red:#c62828;
  --black:#0b0b0b;
  --card:#151515;
  --border:#2b2b2b;
  --text:#ffffff;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--black);
  color:var(--text);
  font-family:Arial,Helvetica,sans-serif;
}
header{
  background:var(--red);
  padding:22px;
  text-align:center;
  font-size:26px;
  font-weight:bold;
}
.container{
  max-width:1500px;
  margin:auto;
  padding:30px 20px 60px;
}
/* FORM */
form{
  background:var(--card);
  padding:25px;
  border-radius:14px;
  margin-bottom:40px;
  box-shadow:0 20px 40px rgba(0,0,0,.6);
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}
label{font-size:13px;opacity:.9}
input,textarea,select{
  width:100%;
  padding:10px;
  margin-top:5px;
  background:#101010;
  color:#fff;
  border:1px solid var(--border);
  border-radius:6px;
}
textarea{min-height:100px}
button{
  background:var(--red);
  border:none;
  padding:11px 20px;
  color:#fff;
  border-radius:6px;
  cursor:pointer;
}
button:hover{background:#a61f1f}
/* PREVIEWS */
.preview-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}
.preview{
  position:relative;
  cursor:grab;
}
.preview.dragging{opacity:.4}
.preview img{
  width:140px;
  height:100px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid var(--border);
  cursor:pointer;
}
.preview .remove{
  position:absolute;
  top:-6px;
  right:-6px;
  background:#000;
  border:1px solid #444;
  font-size:11px;
  padding:3px 6px;
  color:#fff;
  cursor:pointer;
}
/* INVENTORY */
.inventory-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:25px;
}
.card{
  background:var(--card);
  border-radius:14px;
  overflow:hidden;
}
.card .cover-wrap{
  height:190px;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
}
.card img.cover{
  max-height:100%;
  max-width:100%;
  object-fit:contain;
  cursor:pointer;
}
.card-body{padding:16px}
.price{color:var(--red);font-weight:bold;margin:6px 0}
.meta{font-size:13px;opacity:.85;margin-bottom:6px}
.gallery-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
}
.gallery-grid img{
  width:100%;
  height:70px;
  object-fit:cover;
  border-radius:6px;
  cursor:pointer;
}
.actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}
/* MODAL */
#modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.95);
  z-index:999;
  align-items:center;
  justify-content:center;
  cursor:zoom-in;
  overflow:hidden;
}
#modal img{
  max-width:96%;
  max-height:96%;
  transition: transform 0.2s ease;
  transform-origin: center center;
  cursor:inherit;
}
#modal span{
  position:absolute;
  font-size:44px;
  cursor:pointer;
  user-select:none;
}
.close{top:20px;right:30px}
.prev{left:20px}
.next{right:20px}
.zoom-level{
  position:absolute;
  top:25px;
  left:25px;
  color:#fff;
  font-size:16px;
  background:rgba(0,0,0,0.5);
  padding:4px 8px;
  border-radius:6px;
}
</style>
</head>
<body>

<script>
/* ===============================
   AUTH GUARD
================================ */
(function authGuard(){
  const token = localStorage.getItem("authToken");
  if(!token){ window.location.replace("login.html"); return; }
  fetch("https://charged-up-properties-backend.onrender.com/api/verify", {
    headers:{ "Authorization": "Bearer "+token }
  }).then(res => { if(!res.ok){ localStorage.removeItem("authToken"); window.location.replace("login.html"); } })
  .catch(()=>{ localStorage.removeItem("authToken"); window.location.replace("login.html"); });
})();
</script>

<header>Charged Up Properties – Inventory</header>
<button onclick="logout()" style="position:absolute;top:20px;right:20px;background:#000;">Logout</button>
<script>
function logout(){ localStorage.removeItem("authToken"); window.location.href="login.html"; }
</script>

<div class="container">
<form id="propertyForm">
<input type="hidden" id="propertyId">

<div class="grid">
  <div><label>Name<input id="name" required></label></div>
  <div><label>Price<input id="price" type="number"></label></div>
  <div>
    <label>Status
      <select id="status">
        <option>For Sale</option>
        <option>Pending</option>
        <option>Sold</option>
      </select>
    </label>
  </div>
  <div><label>Address<input id="address"></label></div>
  <div><label>Beds<input id="beds" type="number"></label></div>
  <div><label>Baths<input id="baths" type="number" step="0.5"></label></div>
  <div><label>Sq Ft<input id="sqft" type="number"></label></div>
  <div><label>Type<input id="type"></label></div>
  <div><label>Lot Size<input id="lot"></label></div>
  <div><label>Basement<input id="basement"></label></div>
</div>

<label>Description<textarea id="description"></textarea></label>
<label>Cover Image<input type="file" id="coverImage"></label>
<div id="coverPreview" class="preview-row"></div>

<label>Gallery Images (drag to reorder)<input type="file" id="galleryImages" multiple></label>
<div id="galleryPreview" class="preview-row"></div>

<button type="submit">Save Property</button>
<button type="button" onclick="resetForm()" style="margin-left:10px;background:#333">Clear Form</button>
</form>

<div id="inventory" class="inventory-grid"></div>
</div>

<div id="modal">
  <span class="close">&times;</span>
  <span class="prev">&#10094;</span>
  <img id="modalImg">
  <span class="next">&#10095;</span>
  <div class="zoom-level" id="zoomLevel">2x</div>
</div>

<script>
/* ===============================
   AUTH FETCH
================================ */
const API="https://charged-up-properties-backend.onrender.com/api/properties";
async function authFetch(url, options={}) {
  const token=localStorage.getItem("authToken");
  const res=await fetch(url,{...options,headers:{...(options.headers||{}),Authorization:`Bearer ${token}`}});
  if(res.status===401){ localStorage.removeItem("authToken"); window.location.href="login.html"; return; }
  return res;
}

/* ===============================
   PROPERTY LOGIC
================================ */
let properties=[], modalImgs=[], modalIndex=0;
let magnified=false, zoomFactor=2;
const modal=document.getElementById("modal");
const modalImg=document.getElementById("modalImg");
const zoomLevel=document.getElementById("zoomLevel");

function resetForm(){
  propertyForm.reset();
  propertyId.value="";
  coverPreview.innerHTML="";
  galleryPreview.innerHTML="";
}

/* DRAG & REORDER HELPERS */
function enableDrag(container){
  let dragged=null;
  container.addEventListener("dragstart",e=>{ dragged=e.target; e.target.classList.add("dragging"); });
  container.addEventListener("dragend",e=>{ e.target.classList.remove("dragging"); });
  container.addEventListener("dragover",e=>{
    e.preventDefault();
    const after=e.target.closest(".preview");
    if(after && dragged!==after){
      const rect=after.getBoundingClientRect();
      const next=(e.clientX-rect.left>rect.width/2)?after.nextSibling:after;
      container.insertBefore(dragged,next);
    }
  });
}

/* POPULATE FORM FOR EDIT */
function populateForm(p){
  propertyId.value=p.id;
  ["name","price","status","address","beds","baths","sqft","type","lot","basement","description"]
    .forEach(k=>document.getElementById(k).value=p[k]||"");

  // Cover
  coverPreview.innerHTML="";
  if(p.cover_image){
    const div=document.createElement("div");
    div.className="preview";
    div.innerHTML=`<img src="${p.cover_image}" class="cover"><span class="remove">&times;</span>`;
    div.querySelector(".remove").onclick=()=>coverPreview.innerHTML="";
    div.querySelector("img").onclick=()=>openModal(p.cover_image, [p.cover_image]);
    coverPreview.appendChild(div);
  }

  // Gallery
  galleryPreview.innerHTML="";
  modalImgs=[];
  if(p.gallery_images?.length){
    p.gallery_images.forEach(url=>{
      const div=document.createElement("div");
      div.className="preview";
      div.draggable=true;
      div.innerHTML=`<img src="${url}"><span class="remove">&times;</span>`;
      div.querySelector(".remove").onclick=()=>div.remove();
      div.querySelector("img").onclick=()=>openModal(url, p.gallery_images);
      galleryPreview.appendChild(div);
    });
    enableDrag(galleryPreview);
  }
}

/* LOAD PROPERTIES */
async function load(){
  const res=await authFetch(API);
  properties=await res.json();
  inventory.innerHTML="";
  properties.forEach(prop=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="cover-wrap"><img src="${prop.cover_image||''}" class="cover"></div>
      <div class="card-body">
        <div class="price">${prop.price? '$'+prop.price: ''}</div>
        <div class="meta">${prop.beds||''} Beds • ${prop.baths||''} Baths • ${prop.sqft||''} Sq Ft</div>
        <div>${prop.address||''}</div>
        <div class="actions">
          <button onclick="edit(${prop.id})">Edit</button>
          <button onclick="del(${prop.id})">Delete</button>
        </div>
      </div>
    `;
    card.querySelector(".cover").onclick=()=>openModal(prop.cover_image,[prop.cover_image]);
    inventory.appendChild(card);
  });
}

/* DELETE */
async function del(id){ if(confirm("Delete property?")){ await authFetch(`${API}/${id}`,{method:"DELETE"}); load(); } }

/* EDIT */
function edit(id){ const p=properties.find(x=>x.id===id); if(p) populateForm(p); }

/* SUBMIT */
propertyForm.onsubmit=async e=>{
  e.preventDefault();
  const fd=new FormData();
  ["name","price","status","address","beds","baths","sqft","type","lot","basement","description"]
    .forEach(k=>fd.append(k,document.getElementById(k).value));

  if(coverImage.files[0]) fd.append("coverImage",coverImage.files[0]);
  [...galleryImages.files].forEach(f=>fd.append("galleryImages",f));

  const id=propertyId.value;
  await authFetch(id?`${API}/${id}`:API,{method:id?"PUT":"POST",body:fd});
  resetForm();
  load();
};

/* ===============================
   MODAL / MAGNIFY
================================ */
function openModal(src, list){
  if(!src) return;
  modal.style.display="flex";
  modalImg.src=src;
  modalImgs=list||[src];
  modalIndex=modalImgs.indexOf(src);
  magnified=false;
  modalImg.style.transform="scale(1)";
  modal.style.cursor="zoom-in";
  zoomLevel.style.display="none";
}

// Modal close
document.querySelector("#modal .close").onclick=()=>modal.style.display="none";

// Arrows
document.querySelector("#modal .prev").onclick=()=>{
  if(!modalImgs.length) return;
  modalIndex=(modalIndex-1+modalImgs.length)%modalImgs.length;
  modalImg.src=modalImgs[modalIndex];
  magnified=false; modalImg.style.transform="scale(1)"; modal.style.cursor="zoom-in"; zoomLevel.style.display="none";
};
document.querySelector("#modal .next").onclick=()=>{
  if(!modalImgs.length) return;
  modalIndex=(modalIndex+1)%modalImgs.length;
  modalImg.src=modalImgs[modalIndex];
  magnified=false; modalImg.style.transform="scale(1)"; modal.style.cursor="zoom-in"; zoomLevel.style.display="none";
};

// Arrow keys
document.addEventListener("keydown",e=>{
  if(modal.style.display==="flex"){
    if(e.key==="ArrowLeft") document.querySelector("#modal .prev").click();
    if(e.key==="ArrowRight") document.querySelector("#modal .next").click();
  }
});

// Magnify toggle
modalImg.addEventListener("click",()=>{
  magnified=!magnified;
  modal.style.cursor=magnified?"zoom-in":"zoom-out";
  zoomLevel.style.display=magnified?"block":"none";
  modalImg.style.transform=magnified?"scale("+zoomFactor+")":"scale(1)";
});

// Mouse move for magnify
modal.addEventListener("mousemove",e=>{
  if(magnified){
    const rect=modalImg.getBoundingClientRect();
    const x=(e.clientX-rect.left)/rect.width;
    const y=(e.clientY-rect.top)/rect.height;
    modalImg.style.transformOrigin=`${x*100}% ${y*100}%`;
  }
});

// Scroll zoom
modal.addEventListener("wheel",e=>{
  if(magnified){
    e.preventDefault();
    zoomFactor=Math.min(Math.max(1,zoomFactor+(e.deltaY<0?0.2:-0.2)),5);
    modalImg.style.transform="scale("+zoomFactor+")";
    zoomLevel.textContent=Math.round(zoomFactor*100)/100+"x";
  }
}, {passive:false});

/* ===============================
   INITIAL LOAD
================================ */
load();
</script>
</body>
</html>
