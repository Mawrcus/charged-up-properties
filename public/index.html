<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Charged Up Properties Admin</title>
<style>
  body { background:#000; color:#fff; font-family: Arial; margin:0; }
  h1 { color:#D32F2F; text-align:center; padding:20px; }
  .container { width:90%; max-width:1200px; margin:auto; }
  form { background:#111; padding:20px; margin-bottom:20px; border-radius:10px; }
  label { display:block; margin-top:10px; }
  input, select, textarea { width:100%; margin:5px 0; padding:8px; background:#222; color:#fff; border:1px solid #fff; border-radius:5px; }
  button { background:#D32F2F; color:#fff; border:none; padding:10px; cursor:pointer; margin:5px 0; border-radius:5px; }
  button:hover { background:#b71c1c; }
  .property-card { border:1px solid #fff; margin:10px 0; padding:10px; border-radius:5px; }
  .property-images, #galleryPreview, #coverPreview { display:flex; gap:5px; flex-wrap:wrap; }
  .property-images img, #galleryPreview img, #coverPreview img { height:100px; object-fit:contain; cursor:pointer; border:1px solid #fff; border-radius:5px; }
  .preview-div { position:relative; display:inline-block; }
  .preview-div button { position:absolute; top:0; right:0; background:red; color:#fff; padding:2px 5px; font-size:12px; border-radius:0; cursor:pointer; }
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); justify-content:center; align-items:center; z-index:1000; }
  .modal img { max-width:90%; max-height:90%; }
  .close { position:absolute; top:20px; right:30px; font-size:30px; color:#fff; cursor:pointer; }
  .arrow { position:absolute; top:50%; font-size:50px; color:#fff; cursor:pointer; user-select:none; }
  .prev { left:20px; } .next { right:20px; }
</style>
</head>
<body>
<h1>Charged Up Properties Admin</h1>
<div class="container">
  <form id="propertyForm">
    <input type="hidden" id="propertyId">
    <label>Name:</label><input type="text" id="name" required>
    <label>Price:</label><input type="number" id="price" required>
    <label>Status:</label>
    <select id="status">
      <option>For Sale</option>
      <option>Pending</option>
      <option>Sold</option>
    </select>
    <label>Address:</label><input type="text" id="address">
    <label>Beds:</label><input type="number" id="beds">
    <label>Baths:</label><input type="number" step="0.5" id="baths">
    <label>SqFt:</label><input type="number" id="sqft">
    <label>Type:</label><input type="text" id="type">
    <label>Lot Size:</label><input type="text" id="lot">
    <label>Basement:</label><input type="text" id="basement">
    <label>Description:</label><textarea id="description"></textarea>

    <label>Cover Image:</label>
    <input type="file" id="coverImage" accept="image/*">
    <div id="coverPreview"></div>

    <label>Gallery Images:</label>
    <input type="file" id="galleryImages" accept="image/*" multiple>
    <div id="galleryPreview"></div>

    <button type="submit">Save Property</button>
  </form>

  <h2>Current Inventory</h2>
  <div id="propertyList"></div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <span class="close">&times;</span>
  <span class="arrow prev">&#10094;</span>
  <span class="arrow next">&#10095;</span>
  <img id="modalImg" src="">
</div>

<script>
const API_URL = "https://charged-up-properties-backend.onrender.com/api/properties";

let properties = [];
let modalIndex = 0;

const modal = document.getElementById("modal");
const modalImg = document.getElementById("modalImg");

function openModal(images, index) {
  modal.style.display = "flex";
  modalIndex = index;
  modalImg.src = images[modalIndex];
  modal.dataset.images = JSON.stringify(images);
}

document.querySelector(".close").onclick = () => modal.style.display="none";
document.querySelector(".prev").onclick = () => changeImage(-1);
document.querySelector(".next").onclick = () => changeImage(1);

function changeImage(dir){
  const imgs = JSON.parse(modal.dataset.images);
  modalIndex = (modalIndex + dir + imgs.length) % imgs.length;
  modalImg.src = imgs[modalIndex];
}

async function loadProperties(){
  const res = await fetch(API_URL);
  properties = await res.json();
  const list = document.getElementById("propertyList");
  list.innerHTML = "";
  properties.forEach((p, i)=>{
    const div = document.createElement("div");
    div.className="property-card";

    const galleryHTML = (p.gallery_images||[]).map((url,j)=>{
      if(!url) return "";
      return `<img src="${url}" data-index="${j}" data-gallery='${encodeURIComponent(JSON.stringify(p.gallery_images))}' onclick="openGallery(this)">`;
    }).join("");

    div.innerHTML=`
      <div class="cover-image">
        ${p.cover_image ? `<img src="${p.cover_image}" onclick="openModal(['${p.cover_image}'],0)">` : "No Cover"}
      </div>
      <div class="property-images">
        ${galleryHTML}
      </div>
      <strong>${p.name}</strong> - $${p.price} 
      <button onclick="editProperty(${i})">Edit</button>
      <button onclick="deleteProperty(${p.id})">Delete</button>
    `;
    list.appendChild(div);
  });
}

function openGallery(imgEl){
  const images = JSON.parse(decodeURIComponent(imgEl.dataset.gallery));
  const index = parseInt(imgEl.dataset.index);
  openModal(images, index);
}

async function deleteProperty(id){
  if(!confirm("Delete this property?")) return;
  await fetch(`${API_URL}/${id}`, { method:"DELETE" });
  loadProperties();
}

function editProperty(index){
  const p = properties[index];
  document.getElementById("propertyId").value = p.id;
  document.getElementById("name").value = p.name;
  document.getElementById("price").value = p.price;
  document.getElementById("status").value = p.status;
  document.getElementById("address").value = p.address;
  document.getElementById("beds").value = p.beds;
  document.getElementById("baths").value = p.baths;
  document.getElementById("sqft").value = p.sqft;
  document.getElementById("type").value = p.type;
  document.getElementById("lot").value = p.lot;
  document.getElementById("basement").value = p.basement;
  document.getElementById("description").value = p.description;

  // Cover preview
  const coverPreview = document.getElementById("coverPreview");
  coverPreview.innerHTML = "";
  if(p.cover_image){
    const img = document.createElement("img");
    img.src = p.cover_image; img.style.maxHeight="100px"; img.style.objectFit="contain";
    const btn = document.createElement("button");
    btn.textContent="Delete Cover"; btn.onclick=()=>{p.cover_image=null; coverPreview.innerHTML="";};
    coverPreview.append(img, btn);
  }

  // Gallery preview
  const galleryPreview = document.getElementById("galleryPreview");
  galleryPreview.innerHTML="";
  (p.gallery_images||[]).forEach((url, idx)=>{
    if(!url) return;
    const div = document.createElement("div");
    div.className="preview-div";
    const img = document.createElement("img");
    img.src=url;
    const btn = document.createElement("button");
    btn.textContent="X";
    btn.onclick=()=>{p.gallery_images[idx]=null; div.remove();};
    div.append(img, btn);
    galleryPreview.appendChild(div);
  });
}

document.getElementById("propertyForm").onsubmit = async (e)=>{
  e.preventDefault();
  const formData = new FormData();
  const id = document.getElementById("propertyId").value;
  formData.append("name", document.getElementById("name").value);
  formData.append("price", document.getElementById("price").value);
  formData.append("status", document.getElementById("status").value);
  formData.append("address", document.getElementById("address").value);
  formData.append("beds", document.getElementById("beds").value);
  formData.append("baths", document.getElementById("baths").value);
  formData.append("sqft", document.getElementById("sqft").value);
  formData.append("type", document.getElementById("type").value);
  formData.append("lot", document.getElementById("lot").value);
  formData.append("basement", document.getElementById("basement").value);
  formData.append("description", document.getElementById("description").value);

  const cover = document.getElementById("coverImage").files[0];
  if(cover) formData.append("coverImage", cover);

  const gallery = document.getElementById("galleryImages").files;
  for(let i=0;i<gallery.length;i++) formData.append("galleryImages", gallery[i]);

  if(id){
    await fetch(`${API_URL}/${id}`, { method:"PUT", body: formData });
  } else {
    await fetch(API_URL, { method:"POST", body: formData });
  }
  document.getElementById("propertyForm").reset();
  document.getElementById("coverPreview").innerHTML="";
  document.getElementById("galleryPreview").innerHTML="";
  loadProperties();
}

loadProperties();
</script>
</body>
</html>
